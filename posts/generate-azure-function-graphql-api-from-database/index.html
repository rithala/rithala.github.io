<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Generate Azure Function GraphQL API From Database | Kamil Rithaler</title><meta name=keywords content="Azure,Azure Function,TypeScript,JavaScript,Node.js"><meta name=description content="I remember when I first used a GraphQL API in a React SPA. It was a totally different experience from the one I was used to. The flexibility and ease of API discovery with GraphiQL blew my mind. I was using and creating ODATA APIs by then and my first thought was these must be pretty much the same. In fact, the concept is similar. Give front-end developers an API that will allow them to make requests as they want, and get only the data that they want."><meta name=author content="Kamil Rithaler"><link rel=canonical href=https://rithala.github.io/posts/generate-azure-function-graphql-api-from-database/><link crossorigin=anonymous href=/assets/css/stylesheet.48fe8868200bb9109f48654c3725b1f1926ea1c4266b0af0728dff9e74283371.css integrity="sha256-SP6IaCALuRCfSGVMNyWx8ZJuocQmawrwco3/nnQoM3E=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://rithala.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rithala.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rithala.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://rithala.github.io/apple-touch-icon.png><link rel=mask-icon href=https://rithala.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9X7D34Q60Z"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9X7D34Q60Z",{anonymize_ip:!1})}</script><meta property="og:title" content="Generate Azure Function GraphQL API From Database"><meta property="og:description" content="I remember when I first used a GraphQL API in a React SPA. It was a totally different experience from the one I was used to. The flexibility and ease of API discovery with GraphiQL blew my mind. I was using and creating ODATA APIs by then and my first thought was these must be pretty much the same. In fact, the concept is similar. Give front-end developers an API that will allow them to make requests as they want, and get only the data that they want."><meta property="og:type" content="article"><meta property="og:url" content="https://rithala.github.io/posts/generate-azure-function-graphql-api-from-database/"><meta property="og:image" content="https://rithala.github.io/images/_cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-18T09:30:33+02:00"><meta property="article:modified_time" content="2022-07-18T09:30:33+02:00"><meta property="og:site_name" content="Kamil Rithaler BLOG"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rithala.github.io/images/_cover.png"><meta name=twitter:title content="Generate Azure Function GraphQL API From Database"><meta name=twitter:description content="I remember when I first used a GraphQL API in a React SPA. It was a totally different experience from the one I was used to. The flexibility and ease of API discovery with GraphiQL blew my mind. I was using and creating ODATA APIs by then and my first thought was these must be pretty much the same. In fact, the concept is similar. Give front-end developers an API that will allow them to make requests as they want, and get only the data that they want."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://rithala.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Generate Azure Function GraphQL API From Database","item":"https://rithala.github.io/posts/generate-azure-function-graphql-api-from-database/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Generate Azure Function GraphQL API From Database","name":"Generate Azure Function GraphQL API From Database","description":"I remember when I first used a GraphQL API in a React SPA. It was a totally different experience from the one I was used to. The flexibility and ease of API discovery with GraphiQL blew my mind. I was using and creating ODATA APIs by then and my first thought was these must be pretty much the same. In fact, the concept is similar. Give front-end developers an API that will allow them to make requests as they want, and get only the data that they want.","keywords":["Azure","Azure Function","TypeScript","JavaScript","Node.js"],"articleBody":"I remember when I first used a GraphQL API in a React SPA. It was a totally different experience from the one I was used to. The flexibility and ease of API discovery with GraphiQL blew my mind. I was using and creating ODATA APIs by then and my first thought was these must be pretty much the same. In fact, the concept is similar. Give front-end developers an API that will allow them to make requests as they want, and get only the data that they want. However, the approach is very different.\nSince then I had a few tries with building GraphQL APIs in .NET using Hot Chocolate or GraphQL .NET. None of them convinced me to change the approach to how I build my APIs.\nRecently, I started a project where we are building the Node.js API that provides data from an existing SQL database. Our team chose to use Prisma ORM to generate the database client. When I was looking for more information about this ORM I found out that it plays nicely with GraphQL servers and libraries. It can even generate GraphQL schema and resolvers based on a database schema. Then I recalled my past GraphQL fascination and decided to give it a shot.\nIn this article, I am building a PoC that even goes further. Let’s make this API serverless by hosting it on Azure Function App.\nHere you can find the source code of this demo app.\nWhy do that? Why not :) There are many use cases when you need to deliver quickly the API for existing data. Or you want to focus on the database design and the API just transports data back and forth between clients and a database. This is also a good starting point for developing a new API.\nFor sure in a real-world scenario, there is much more that has to be done like authorization, side effects or integrations with other systems.\nPrerequisites Node.js LTS Azure Functions Core Tools Database, you can use the academic classic’s Northwind Azure CLI or Azure Functions VS Code extension to deploy the app to Azure Prepare database First, you need a database. In this example, I use the Northwind sample database hosted in Azure. Here is the official quickstart guide. You can create a simple DTU-based basic single instance for a testing purpose. Remember to enable SQL authentication in the SQL server configuration. For now, Prisma does not support Azure AD authentication. Note down the server name, database name, admin user name and password. You will need this to create the connection URL.\nNow you can populate the database. Copy the SQL from Azure SQL Northwind sample and execute on the created database using SQL Management Studio, Azure Data Studio or just simply in Azure Portal using Query Editor in the database resource. If you are connecting for the first time you will be asked to whitelist the IP address in the Azure SQL server firewall settings.\nThe script execution may take a while. The created database schema should look like this.\nAzure Function project setup I recommend using the Azure Functions VS Code extension to create the project.\nPress CTRL + SHIFT + P type az and select create a new project. Use the current dictionary or select a different one. Select TypeScript. Now you can select the HTTP trigger function to create. Provide the name. This step is quite important. If you want to secure your API yourself or use the App Service built-in authentication (Easy Auth) then choose the “Anonymous” authorization level. In this demo, I selected the “Function” level for simplicity. You will use the function key in the “x-functions-key” header to authenticate requests. Installing dependencies There is a list of libraries that have to be installed. The most important ones are:\nprisma - previously described ORM graphql@15 - GraphQL language runtime. Version 15 is required by other used packages. type-graphql - Creating GraphQL schema using TypeScript decorators. typegraphql-prisma - Generating type-graphql classes based on Prisma model. apollo-server-azure-functions - Host Apollo (popular GraphQL server) on an Azure Function App. reflect-metadata - Metadata reflection polyfill. You can use two following commands to install all required dependencies.\nnpm i apollo-server-azure-functions reflect-metadata graphql@15 graphql-fields graphql-scalars type-graphql class-validator @prisma/client npm i -D prisma typegraphql-prisma @types/graphql-fields TypeScript configuration TypeGraphQL package requires additional TypeScript configuration to work correctly.\nSo you need to change the tsconfig.json file from this:\n{ \"compilerOptions\": { \"module\": \"commonjs\", \"target\": \"es6\", \"outDir\": \"dist\", \"rootDir\": \".\", \"sourceMap\": true, \"strict\": false } } To make it look like this:\n{ \"compilerOptions\": { \"module\": \"commonjs\", \"outDir\": \"dist\", \"rootDir\": \".\", \"sourceMap\": true, \"strict\": false, \"target\": \"es2018\", \"lib\": [\"es2018\", \"esnext.asynciterable\"], \"esModuleInterop\": true, \"experimentalDecorators\": true, \"emitDecoratorMetadata\": true } } Prisma project initialization Prisma needs its configuration. The easiest way to start is to run the CLI command.\nnpx prisma init --datasource-provider sqlserver This creates two files. The prisma/schema.prisma schema file and .env for keeping the design-time database URL.\nYou should have kept the values that I mentioned during creating the database. Edit .env file using those values.\nDATABASE_URL=sqlserver://{server name}.database.windows.net:1433;database={database name};user={admin user name};password={admin password};encrypt=true Also, you need to change the Prisma schema file to include the GraphQL generator in it. Let’s change prisma/schema.prisma to include this.\ngenerator client { provider = \"prisma-client-js\" } generator typegraphql { provider = \"typegraphql-prisma\" output = \"../generated/type-graphql\" } datasource db { provider = \"sqlserver\" url = env(\"DATABASE_URL\") } The next steps are to pull the database schema and generate the database client and GraphQL schema. Run these commands.\nnpx prisma db pull npx prisma generate If the command run successfully you should see many files generated under generated/type-graphql folder.\nGraphQL function Finally, it is time to wire all things together and test the app. The first step is to make some changes to the function definition located in GraphQL/function.json.\n{ \"bindings\": [ { \"authLevel\": \"function\", \"type\": \"httpTrigger\", \"direction\": \"in\", \"name\": \"req\", \"methods\": [\"get\", \"post\", \"options\"] }, { \"type\": \"http\", \"direction\": \"out\", \"name\": \"$return\" } ], \"scriptFile\": \"../dist/GraphQL/index.js\" } The difference between the default configurations is out the binding name changed to $return to take the output from the returned value, and added options to methods to support CORS.\nReplace the GraphQL/intex.ts content with the following code.\nimport 'reflect-metadata'; import { PrismaClient } from '@prisma/client'; import { buildSchema } from 'type-graphql'; import { AzureFunction, Context, HttpRequest } from '@azure/functions'; import { ApolloServer } from 'apollo-server-azure-functions'; import { resolvers } from '../generated/type-graphql'; async function getClient() { const prisma = new PrismaClient(); await prisma.$connect(); return prisma; } async function buildGraphQlSchema() { return await buildSchema({ resolvers, validate: false, }); } // Lazy initialization of Prisma client and GraphQL schema const prismaClientPromise = getClient(); const graphqlSchemaPromise = buildGraphQlSchema(); async function buildApolloHandler() { const schema = await graphqlSchemaPromise; const prismaClient = await prismaClientPromise; const server = new ApolloServer({ schema: schema, csrfPrevention: true, cache: 'bounded', // enabled introspection to test the deployed function in Apollo Studio Sandbox introspection: true, context: { prisma: prismaClient, }, }); return server.createHandler({ disableHealthCheck: true, }); } // Lazy initialization of Apollo Azure Function handler const apolloHandlerPromise = buildApolloHandler(); export const graphqlHandler: AzureFunction = async function ( context: Context, req: HttpRequest ): Promise\u003cvoid\u003e { // Resolve Apollo handler instance const handler = await apolloHandlerPromise; return await new Promise((resolve, reject) =\u003e { const contextWithPromisifiedDone = { ...context, // This hack is required as we require some async operation prior using handler. done: (err?: Error | string | null, result?: any) =\u003e { if (err) { reject(err); return; } resolve(result); }, }; // Run Apollo handler handler(contextWithPromisifiedDone, req); }); }; Ok, try to run the app.\nnpm run start Unfortunately, quickly after the app starts the error message appears.\nUnhandledPromiseRejectionWarning: Error: Some errors occurred while generating GraphQL schema: Input Object type CustomerCustomerDemoUpdateManyMutationInput must define one or more fields. Input Object type EmployeeTerritoriesUpdateManyMutationInput must define one or more fields. After short googling, you can find out this is related to Prisma’s issue#4004. For now, there is no well no workaround. You can try to automate finding empty input classes and add some dummy property. In this case, I added a dummy property to CustomerCustomerDemoUpdateManyMutationInput.ts and EmployeeTerritoriesUpdateManyMutationInput.ts manually.\n// generated/type-graphql/resolvers/inputs/CustomerCustomerDemoUpdateManyMutationInput.ts import * as TypeGraphQL from 'type-graphql'; import * as GraphQLScalars from 'graphql-scalars'; import { Prisma } from '@prisma/client'; import { DecimalJSScalar } from '../../scalars'; @TypeGraphQL.InputType('CustomerCustomerDemoUpdateManyMutationInput', { isAbstract: true, }) export class CustomerCustomerDemoUpdateManyMutationInput { @TypeGraphQL.Field((_type) =\u003e String, { nullable: false, }) DoNotUseThisInputType!: string; } // generated/type-graphql/resolvers/inputs/EmployeeTerritoriesUpdateManyMutationInput.ts import * as TypeGraphQL from 'type-graphql'; import * as GraphQLScalars from 'graphql-scalars'; import { Prisma } from '@prisma/client'; import { DecimalJSScalar } from '../../scalars'; @TypeGraphQL.InputType('EmployeeTerritoriesUpdateManyMutationInput', { isAbstract: true, }) export class EmployeeTerritoriesUpdateManyMutationInput { @TypeGraphQL.Field((_type) =\u003e String, { nullable: false, }) DoNotUseThisInputType!: string; } Second try with npm run start and now without errors! Open the following URL in the browser http://localhost:7071/api/GraphQL. You should be redirected to Apollo Studio Sandbox. Now you can explore the API schema.\nThe generated API is quite rich with queries and mutations. The API supports full CRUD operations. You can get, create, update, remove, get rows with related entities, filter them or even do aggregations like COUNT, AVG, SUM, MAX or MIN.\nPublish the function app to Azure First, you need to create the function app in the resource group. I tested it on the Windows consumption plan only.\nAfter the function is created go to the created resource and open the “Configuration” pane. You got to add the “DATABASE_URL” to the application settings. Take the value from the .env file.\nThe last thing to do here is to select the “General settings” tab and change the platform to 64 Bit. Prisma binaries only work with 64-bit platforms. Remember to save changes before leaving the configuration.\nTo use this API in Apollo Studio you have to change the CORS settings. Go to API -\u003e CORS, remove the default rule and add a new one. As you are already here, go to the Functions -\u003e App keys pane and note down the default key.\nIt is time to go back to VS Code and deploy the code to Azure. Again, press CTRL + SHIFT + P type az and select Azure Functions: Deploy to Function App. You might be asked to log in, then chose the target subscription and previously created function app. Confirm that you are aware that deployment will erase the target function app.\nIt takes a while to deploy the function app. When it is done you can test the deployed function in Apollo Studio Sandbox. Open https://studio.apollographql.com/sandbox/explorer in the browser and click the cogwheel button to open the sandbox settings. Change the endpoint to the deployed function URL and add the x-functions-key header with the copied value from Functions -\u003e App keys.\nAfter saving changes you should be connected to the deployed function app.\nSummary After spending a few minutes you got a fully working API with all CRUD methods and even more. It is just the beginning. You can extend the generated model with custom resolvers and role-based authorization and we are getting closer to a rich API build pretty quickly.\n","wordCount":"1836","inLanguage":"en","image":"https://rithala.github.io/images/_cover.png","datePublished":"2022-07-18T09:30:33+02:00","dateModified":"2022-07-18T09:30:33+02:00","author":{"@type":"Person","name":"Kamil Rithaler"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rithala.github.io/posts/generate-azure-function-graphql-api-from-database/"},"publisher":{"@type":"Organization","name":"Kamil Rithaler","logo":{"@type":"ImageObject","url":"https://rithala.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rithala.github.io accesskey=h title="Kamil Rithaler (Alt + H)"><img src=https://rithala.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Kamil Rithaler</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rithala.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://rithala.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://rithala.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rithala.github.io>Home</a>&nbsp;»&nbsp;<a href=https://rithala.github.io/posts/>Posts</a></div><h1 class=post-title>Generate Azure Function GraphQL API From Database</h1><div class=post-meta><span title='2022-07-18 09:30:33 +0200 +0200'>July 18, 2022</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Kamil Rithaler&nbsp;|&nbsp;<a href=https://github.com/rithala/content/posts/generate-azure-function-graphql-api-from-database/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://rithala.github.io/posts/generate-azure-function-graphql-api-from-database/images/_cover.png alt="Generate Azure Function GraphQL API From Database"></figure><div class=post-content><p>I remember when I first used a GraphQL API in a React SPA. It was a totally different experience from the one I was used to. The flexibility and ease of API discovery with GraphiQL blew my mind. I was using and creating ODATA APIs by then and my first thought was these must be pretty much the same. In fact, the concept is similar. Give front-end developers an API that will allow them to make requests as they want, and get only the data that they want. However, the approach is very different.</p><p>Since then I had a few tries with building GraphQL APIs in .NET using <a href=https://chillicream.com/docs/hotchocolate>Hot Chocolate</a> or <a href=https://graphql-dotnet.github.io/>GraphQL .NET</a>. None of them convinced me to change the approach to how I build my APIs.</p><p>Recently, I started a project where we are building the Node.js API that provides data from an existing SQL database. Our team chose to use <a href=https://www.prisma.io/>Prisma</a> ORM to generate the database client. When I was looking for more information about this ORM I found out that it plays nicely with GraphQL servers and libraries. It can even <strong>generate GraphQL schema and resolvers based on a database schema</strong>. Then I recalled my past GraphQL fascination and decided to give it a shot.</p><p>In this article, I am building a PoC that even goes further. Let&rsquo;s make this API serverless by hosting it on Azure Function App.</p><p><a href=https://github.com/rithala/graphql-az-function>Here</a> you can find the source code of this demo app.</p><h2 id=why-do-that>Why do that?<a hidden class=anchor aria-hidden=true href=#why-do-that>#</a></h2><p>Why not :) There are many use cases when you need to deliver quickly the API for existing data. Or you want to focus on the database design and the API just transports data back and forth between clients and a database. This is also a good starting point for developing a new API.</p><p>For sure in a real-world scenario, there is much more that has to be done like authorization, side effects or integrations with other systems.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><ul><li><a href=https://nodejs.org/en/>Node.js LTS</a></li><li><a href=https://github.com/Azure/azure-functions-core-tools>Azure Functions Core Tools</a></li><li>Database, you can use the academic classic&rsquo;s <a href=https://github.com/Microsoft/sql-server-samples/tree/master/samples/databases/northwind-pubs>Northwind</a></li><li>Azure CLI or Azure Functions VS Code extension to deploy the app to Azure</li></ul><h2 id=prepare-database>Prepare database<a hidden class=anchor aria-hidden=true href=#prepare-database>#</a></h2><p>First, you need a database. In this example, I use the Northwind sample database hosted in Azure. Here is the <a href="https://docs.microsoft.com/en-us/azure/azure-sql/database/single-database-create-quickstart?view=azuresql&tabs=azure-portal">official quickstart guide</a>. You can create a simple DTU-based basic single instance for a testing purpose. Remember to enable <strong>SQL authentication</strong> in the SQL server configuration. For now, Prisma does not support Azure AD authentication. Note down the <strong>server name</strong>, <strong>database name</strong>, <strong>admin user name</strong> and <strong>password</strong>. You will need this to create the connection URL.</p><p>Now you can populate the database. Copy the SQL from <a href=https://raw.githubusercontent.com/microsoft/sql-server-samples/master/samples/databases/northwind-pubs/instnwnd%20(Azure%20SQL%20Database).sql>Azure SQL Northwind sample</a> and execute on the created database using SQL Management Studio, Azure Data Studio or just simply in Azure Portal using Query Editor in the database resource. If you are connecting for the first time you will be asked to whitelist the IP address in the Azure SQL server firewall settings.</p><p><img loading=lazy src=./images/img1.jpg#center alt="Northwind SQL script in the query editor"></p><p>The script execution may take a while. The created database schema should look like this.</p><p><img loading=lazy src=./images/img2.jpg#center alt="Created database schema"></p><h2 id=azure-function-project-setup>Azure Function project setup<a hidden class=anchor aria-hidden=true href=#azure-function-project-setup>#</a></h2><p>I recommend using the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-develop-vs-code?tabs=nodejs">Azure Functions VS Code extension</a> to create the project.</p><p>Press <code>CTRL + SHIFT + P</code> type <code>az</code> and select create a new project.
<img loading=lazy src=./images/img3.jpg#center alt="Create an Azure Function project">
Use the current dictionary or select a different one.
<img loading=lazy src=./images/img4.jpg#center alt="Create an Azure Function project">
Select TypeScript.
<img loading=lazy src=./images/img5.jpg#center alt="Create an Azure Function project">
Now you can select the HTTP trigger function to create.
<img loading=lazy src=./images/img6.jpg#center alt="Create an Azure Function project">
Provide the name.
<img loading=lazy src=./images/img7.jpg#center alt="Create an Azure Function project">
This step is quite important. If you want to secure your API yourself or use the App Service <a href=https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization>built-in authentication</a> (Easy Auth) then choose the &ldquo;Anonymous&rdquo; authorization level. In this demo, I selected the &ldquo;Function&rdquo; level for simplicity. You will use the function key in the &ldquo;x-functions-key&rdquo; header to authenticate requests.
<img loading=lazy src=./images/img8.jpg#center alt="Create an Azure Function project"></p><h2 id=installing-dependencies>Installing dependencies<a hidden class=anchor aria-hidden=true href=#installing-dependencies>#</a></h2><p>There is a list of libraries that have to be installed. The most important ones are:</p><ul><li><a href=https://www.npmjs.com/package/prisma>prisma</a> - previously described ORM</li><li><a href=https://www.npmjs.com/package/graphql/v/15.8.0>graphql@15</a> - GraphQL language runtime. Version 15 is required by other used packages.</li><li><a href=https://www.npmjs.com/package/type-graphql>type-graphql</a> - Creating GraphQL schema using TypeScript decorators.</li><li><a href=https://www.npmjs.com/package/typegraphql-prisma>typegraphql-prisma</a> - Generating type-graphql classes based on Prisma model.</li><li><a href=https://www.npmjs.com/package/apollo-server-azure-functions>apollo-server-azure-functions</a> - Host Apollo (popular GraphQL server) on an Azure Function App.</li><li><a href=https://www.npmjs.com/package/reflect-metadata>reflect-metadata</a> - Metadata reflection polyfill.</li></ul><p>You can use two following commands to install all required dependencies.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm i apollo-server-azure-functions reflect-metadata graphql@15 graphql-fields graphql-scalars type-graphql class-validator @prisma/client
</span></span><span style=display:flex><span>npm i -D prisma typegraphql-prisma @types/graphql-fields
</span></span></code></pre></div><h2 id=typescript-configuration>TypeScript configuration<a hidden class=anchor aria-hidden=true href=#typescript-configuration>#</a></h2><p>TypeGraphQL package <a href=https://typegraphql.com/docs/installation.html>requires additional TypeScript configuration</a> to work correctly.</p><p>So you need to change the <code>tsconfig.json</code> file from this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;compilerOptions&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;module&#34;</span>: <span style=color:#e6db74>&#34;commonjs&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;es6&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;outDir&#34;</span>: <span style=color:#e6db74>&#34;dist&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;rootDir&#34;</span>: <span style=color:#e6db74>&#34;.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;sourceMap&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;strict&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To make it look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;compilerOptions&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;module&#34;</span>: <span style=color:#e6db74>&#34;commonjs&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;outDir&#34;</span>: <span style=color:#e6db74>&#34;dist&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;rootDir&#34;</span>: <span style=color:#e6db74>&#34;.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;sourceMap&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;strict&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;es2018&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;lib&#34;</span>: [<span style=color:#e6db74>&#34;es2018&#34;</span>, <span style=color:#e6db74>&#34;esnext.asynciterable&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;esModuleInterop&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;experimentalDecorators&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;emitDecoratorMetadata&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=prisma-project-initialization>Prisma project initialization<a hidden class=anchor aria-hidden=true href=#prisma-project-initialization>#</a></h2><p>Prisma needs its configuration. The easiest way to start is to run the CLI command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npx prisma init --datasource-provider sqlserver
</span></span></code></pre></div><p>This creates two files. The <code>prisma/schema.prisma</code> schema file and <code>.env</code> for keeping the design-time database URL.</p><p>You should have kept the values that I mentioned during creating the database. Edit <code>.env</code> file using those values.</p><pre tabindex=0><code>DATABASE_URL=sqlserver://{server name}.database.windows.net:1433;database={database name};user={admin user name};password={admin password};encrypt=true
</code></pre><p>Also, you need to change the Prisma schema file to include the GraphQL generator in it. Let&rsquo;s change <code>prisma/schema.prisma</code> to include this.</p><pre tabindex=0><code>generator client {
  provider = &#34;prisma-client-js&#34;
}

generator typegraphql {
  provider = &#34;typegraphql-prisma&#34;
  output   = &#34;../generated/type-graphql&#34;
}

datasource db {
  provider = &#34;sqlserver&#34;
  url      = env(&#34;DATABASE_URL&#34;)
}
</code></pre><p>The next steps are to pull the database schema and generate the database client and GraphQL schema. Run these commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npx prisma db pull
</span></span><span style=display:flex><span>npx prisma generate
</span></span></code></pre></div><p>If the command run successfully you should see many files generated under <code>generated/type-graphql</code> folder.</p><h2 id=graphql-function>GraphQL function<a hidden class=anchor aria-hidden=true href=#graphql-function>#</a></h2><p>Finally, it is time to wire all things together and test the app. The first step is to make some changes to the function definition located in <code>GraphQL/function.json</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;bindings&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;authLevel&#34;</span>: <span style=color:#e6db74>&#34;function&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;httpTrigger&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;direction&#34;</span>: <span style=color:#e6db74>&#34;in&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;req&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;methods&#34;</span>: [<span style=color:#e6db74>&#34;get&#34;</span>, <span style=color:#e6db74>&#34;post&#34;</span>, <span style=color:#e6db74>&#34;options&#34;</span>]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;direction&#34;</span>: <span style=color:#e6db74>&#34;out&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;$return&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scriptFile&#34;</span>: <span style=color:#e6db74>&#34;../dist/GraphQL/index.js&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The difference between the default configurations is out the binding name changed to <code>$return</code> to take the output from the returned value, and added <code>options</code> to methods to support CORS.</p><p>Replace the <code>GraphQL/intex.ts</code> content with the following code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;reflect-metadata&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>PrismaClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@prisma/client&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>buildSchema</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;type-graphql&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AzureFunction</span>, <span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>HttpRequest</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@azure/functions&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ApolloServer</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;apollo-server-azure-functions&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>resolvers</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../generated/type-graphql&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getClient() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prisma</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrismaClient</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>$connect</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>prisma</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>buildGraphQlSchema() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>buildSchema</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolvers</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>validate</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Lazy initialization of Prisma client and GraphQL schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prismaClientPromise</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getClient</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>graphqlSchemaPromise</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>buildGraphQlSchema</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>buildApolloHandler() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>graphqlSchemaPromise</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prismaClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prismaClientPromise</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ApolloServer</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>schema</span>: <span style=color:#66d9ef>schema</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>csrfPrevention</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cache</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;bounded&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// enabled introspection to test the deployed function in Apollo Studio Sandbox
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>introspection</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>prisma</span>: <span style=color:#66d9ef>prismaClient</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>createHandler</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>disableHealthCheck</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Lazy initialization of Apollo Azure Function handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apolloHandlerPromise</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>buildApolloHandler</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>graphqlHandler</span>: <span style=color:#66d9ef>AzureFunction</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> (
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>Context</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>HttpRequest</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Resolve Apollo handler instance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>apolloHandlerPromise</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>contextWithPromisifiedDone</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>context</span>,
</span></span><span style=display:flex><span>      <span style=color:#75715e>// This hack is required as we require some async operation prior using handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>done</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>err?</span>: <span style=color:#66d9ef>Error</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>result?</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Run Apollo handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>contextWithPromisifiedDone</span>, <span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Ok, try to run the app.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run start
</span></span></code></pre></div><p>Unfortunately, quickly after the app starts the error message appears.</p><pre tabindex=0><code class=language-log data-lang=log>UnhandledPromiseRejectionWarning: Error: Some errors occurred while generating GraphQL schema:
  Input Object type CustomerCustomerDemoUpdateManyMutationInput must define one or more fields.
    Input Object type EmployeeTerritoriesUpdateManyMutationInput must define one or more fields.
</code></pre><p>After short googling, you can find out this is related to Prisma&rsquo;s <a href=https://github.com/prisma/prisma/issues/4004>issue#4004</a>. For now, there is no well no workaround. You can try to automate finding empty input classes and add some dummy property. In this case, I added a dummy property to <code>CustomerCustomerDemoUpdateManyMutationInput.ts</code> and <code>EmployeeTerritoriesUpdateManyMutationInput.ts</code> manually.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// generated/type-graphql/resolvers/inputs/CustomerCustomerDemoUpdateManyMutationInput.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>TypeGraphQL</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;type-graphql&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>GraphQLScalars</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;graphql-scalars&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Prisma</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@prisma/client&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DecimalJSScalar</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../scalars&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@TypeGraphQL</span>.<span style=color:#a6e22e>InputType</span>(<span style=color:#e6db74>&#39;CustomerCustomerDemoUpdateManyMutationInput&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isAbstract</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerCustomerDemoUpdateManyMutationInput</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>@TypeGraphQL</span>.<span style=color:#a6e22e>Field</span>((<span style=color:#a6e22e>_type</span>) <span style=color:#f92672>=&gt;</span> String, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nullable</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DoNotUseThisInputType</span><span style=color:#f92672>!:</span> <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// generated/type-graphql/resolvers/inputs/EmployeeTerritoriesUpdateManyMutationInput.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>TypeGraphQL</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;type-graphql&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>GraphQLScalars</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;graphql-scalars&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Prisma</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@prisma/client&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DecimalJSScalar</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../scalars&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>@TypeGraphQL</span>.<span style=color:#a6e22e>InputType</span>(<span style=color:#e6db74>&#39;EmployeeTerritoriesUpdateManyMutationInput&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isAbstract</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EmployeeTerritoriesUpdateManyMutationInput</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>@TypeGraphQL</span>.<span style=color:#a6e22e>Field</span>((<span style=color:#a6e22e>_type</span>) <span style=color:#f92672>=&gt;</span> String, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nullable</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DoNotUseThisInputType</span><span style=color:#f92672>!:</span> <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Second try with <code>npm run start</code> and now without errors! Open the following URL in the browser <code>http://localhost:7071/api/GraphQL</code>. You should be redirected to Apollo Studio Sandbox. Now you can explore the API schema.</p><p><img loading=lazy src=./images/img9.jpg#center alt="Apollo Studio Sandbox"></p><p>The generated API is quite rich with queries and mutations. The API supports full CRUD operations. You can get, create, update, remove, get rows with related entities, filter them or even do aggregations like COUNT, AVG, SUM, MAX or MIN.</p><p><img loading=lazy src=./images/img10.jpg#center alt="Apollo Studio Sandbox"></p><h2 id=publish-the-function-app-to-azure>Publish the function app to Azure<a hidden class=anchor aria-hidden=true href=#publish-the-function-app-to-azure>#</a></h2><p>First, you need to create the function app in the resource group. I tested it on the Windows consumption plan only.</p><p><img loading=lazy src=./images/img11.jpg#center alt="Create Azure Function app parameters"></p><p>After the function is created go to the created resource and open the &ldquo;Configuration&rdquo; pane. You got to add the &ldquo;<strong>DATABASE_URL</strong>&rdquo; to the application settings. Take the value from the <code>.env</code> file.</p><p><img loading=lazy src=./images/img12.jpg#center alt="DATABASE_URL setting"></p><p>The last thing to do here is to select the &ldquo;General settings&rdquo; tab and change the platform to <strong>64 Bit</strong>. Prisma binaries only work with <strong>64-bit</strong> platforms. Remember to save changes before leaving the configuration.</p><p><img loading=lazy src=./images/img13.jpg#center alt="64-bit platform"></p><p>To use this API in Apollo Studio you have to change the CORS settings. Go to <code>API -> CORS</code>, remove the default rule and add a new one.
<img loading=lazy src=./images/img17.jpg#center alt="CORS settings"></p><p>As you are already here, go to the <code>Functions -> App keys</code> pane and note down the default key.</p><p><img loading=lazy src=./images/img14.jpg#center alt="Copy default app key"></p><p>It is time to go back to VS Code and deploy the code to Azure. Again, press <code>CTRL + SHIFT + P</code> type <code>az</code> and select <code>Azure Functions: Deploy to Function App</code>. You might be asked to log in, then chose the target subscription and previously created function app. Confirm that you are aware that deployment will erase the target function app.</p><p><img loading=lazy src=./images/img15.jpg#center alt=Confirmation></p><p>It takes a while to deploy the function app. When it is done you can test the deployed function in Apollo Studio Sandbox. Open <code>https://studio.apollographql.com/sandbox/explorer</code> in the browser and click the cogwheel button to open the sandbox settings. Change the endpoint to the deployed function URL and add the <code>x-functions-key</code> header with the copied value from <code>Functions -> App keys</code>.</p><p><img loading=lazy src=./images/img16.jpg#center alt="Sandbox settings"></p><p>After saving changes you should be connected to the deployed function app.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>After spending a few minutes you got a fully working API with all CRUD methods and even more. It is just the beginning. You can extend the generated model with custom resolvers and role-based authorization and we are getting closer to a rich API build pretty quickly.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://rithala.github.io/tags/azure/>Azure</a></li><li><a href=https://rithala.github.io/tags/azure-function/>Azure Function</a></li><li><a href=https://rithala.github.io/tags/typescript/>TypeScript</a></li><li><a href=https://rithala.github.io/tags/javascript/>JavaScript</a></li><li><a href=https://rithala.github.io/tags/node.js/>Node.js</a></li></ul><nav class=paginav><a class=prev href=https://rithala.github.io/posts/generate-typescript-api-client-and-use-it-in-spfx-project/><span class=title>« Prev</span><br><span>How To Generate the TypeScript API Client and Use It in an SPFx Project</span></a>
<a class=next href=https://rithala.github.io/posts/new-power-automate-tools-version/><span class=title>Next »</span><br><span>New Power Automate Tools Version</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Generate Azure Function GraphQL API From Database on twitter" href="https://twitter.com/intent/tweet/?text=Generate%20Azure%20Function%20GraphQL%20API%20From%20Database&url=https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f&hashtags=Azure%2cAzureFunction%2cTypeScript%2cJavaScript%2cNode.js"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Azure Function GraphQL API From Database on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f&title=Generate%20Azure%20Function%20GraphQL%20API%20From%20Database&summary=Generate%20Azure%20Function%20GraphQL%20API%20From%20Database&source=https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Azure Function GraphQL API From Database on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f&title=Generate%20Azure%20Function%20GraphQL%20API%20From%20Database"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Azure Function GraphQL API From Database on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Azure Function GraphQL API From Database on whatsapp" href="https://api.whatsapp.com/send?text=Generate%20Azure%20Function%20GraphQL%20API%20From%20Database%20-%20https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Generate Azure Function GraphQL API From Database on telegram" href="https://telegram.me/share/url?text=Generate%20Azure%20Function%20GraphQL%20API%20From%20Database&url=https%3a%2f%2frithala.github.io%2fposts%2fgenerate-azure-function-graphql-api-from-database%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div class=utterances></div><script src=https://utteranc.es/client.js repo=rithala/rithala.github.io issue-term=pathname label=Post theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://rithala.github.io>Kamil Rithaler</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>